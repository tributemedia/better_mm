<?php
// $Id$

/**
 * @file
 * Provides configuration page to choose a menu to pull items from and create a custom menu using those items.
 */

// =================================
// = Implements hook_permission(). =
// =================================

function better_mm_permission() {
	$permission = array(
		'administer better mm' => array(
			'title' => t('Administer Better Mega Menu'),
			'description' => t('Configure Better Mega Menu Settings.'),
		),
	);
	return $permission;
}

// ===========================
// = Implements hook_menu(). =
// ===========================

function better_mm_menu() {
	$items['admin/structure/better_mm'] = array(
		'title' => t('Better Mega Menu Settings'),
		'description' => t('Configure Better Mega Menu Settings.'),
		'page callback' => 'drupal_get_form',
		'page arguments' => array('better_mm_admin_settings'),
		'access arguments' => array('administer better mm'),
	);
	return $items;
}

// ================================
// = Construct admin settins form =
// ================================

function better_mm_admin_settings($form, &$form_state) {
	$show_wide = FALSE;
	$show_mega = FALSE;
	$wide_access = FALSE;
	$mega_access = FALSE;
	
  $form['bmm_menu'] = array(
    '#title' => t('Select Menu'),
	  '#type' => 'select',
	  '#options' => better_mm_get_options('menus'),
	  '#default_value' => variable_get('bmm_menu', 'main-menu'),
	  '#ajax' => array(
	    'callback' => 'better_mm_menu_items_ajax_callback',
	    'wrapper' => 'bmm-menu-items',
	    'method' => 'replace',
	    'effect' => 'fade',
	  ),
	);
	$form['bmm_menu_items_fieldset'] = array(
    '#title' => t("Menu Items"),
    // The prefix/suffix provide the div that we're replacing, named by
    // #ajax['wrapper'] above.
    '#prefix' => '<div id="bmm-menu-items">',
    '#suffix' => '</div>',
    '#type' => 'fieldset',
    '#description' => t('Description here.'),
	);
	
	$menu_selection = !empty($form_state['values']['bmm_menu']) ? $form_state['values']['bmm_menu'] : 'main-menu';
	$menu_items = menu_navigation_links($menu_selection);
	
	foreach ($menu_items as $menu_item) {
		$item_name = $menu_item['title'];
		$variable_name = 'bmm_style_' . strtolower($item_name);
		$form['bmm_menu_items_fieldset']['bmm_menu_item_' . strtolower($item_name)] = array(
			'#type' => 'fieldset',
			'#title' => t($item_name),
		);
		$form['bmm_menu_items_fieldset']['bmm_menu_item_' . strtolower($item_name)][$variable_name] = array(
			'#type' => 'select',
			'#title' => t('Menu Item Style'),
			'#options' => better_mm_get_options('styles'),
			'#default_value' => variable_get($variable_name, 'standard'),
			'#prefix' => '<div id="bmm-menu-item-' . strtolower($item_name) . '-settings">',
			'#suffix' => '</div>',
			'#ajax' => array(
 				'callback' => 'better_mm_style_ajax_callback',
 				'wrapper' => 'bmm-style-settings',
 				'method' => 'replace',
 				'effect' => 'fade',
			),
		);
		$form['bmm_menu_items_fieldset']['bmm_menu_item_' . strtolower($item_name)]['bmm_menu_' . strtolower($item_name) . '_style_settings_subset'] = array(
			'#type' => 'fieldset',
			'#prefix' => '<div id="bmm-style-settings">',
			'#suffix' => '</div>',
			'#description' => t('description here'),
		);
		
		$bmm_item_style = !empty($form_state['triggering_element']['#value']) ?
 			$form_state['triggering_element']['#value'] : 'standard';
		
		$form['bmm_menu_items_fieldset']['bmm_menu_item_' . strtolower($item_name)]['bmm_menu_item_' . strtolower($item_name) . '_' . $bmm_item_style . '_setting'] = array(
		  //'#access' => $wide_access,
		  '#type' => 'textfield',
		  '#title' => t('Image Upload'),
		);
	}
	return $form;
}

// ==================================================
// = Ajax callback for menu items of selected menu. =
// ==================================================

function better_mm_menu_items_ajax_callback($form, $form_state) {
	return $form['bmm_menu_items_fieldset'];
}

// =======================================
// = Ajax callback for menu items style. =
// =======================================

function better_mm_style_ajax_callback($form, $form_state) {
	dsm($form_state);
	$index = $form_state['triggering_element']['#array_parents'];
	return $form[$index[0]][$index[1]][$index[2]];
}

// ==================================================
// = Get list of options for select list form item. =
// ==================================================

function better_mm_get_options($item) {
	if ($item == 'menus') {
		$options = menu_get_menus();
	}
	
	if ($item == 'styles') {
		$options = array(
			'standard' => 'Standard',
			'wide' => 'Wide',
			'mega' => 'Mega Menu',
		);	
	}
	return $options;
}